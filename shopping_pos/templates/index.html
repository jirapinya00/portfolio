{% extends 'base.html' %}

{% block title %}หน้าขายสินค้า | POS{% endblock %}

{% block content %}
<main class="main-content">
  <div class="page-header">
    <h1>ขายสินค้า</h1>
    <p>เลือกรายการสินค้าแล้วชำระเงิน</p>
  </div>

  <!-- รายการสินค้า -->
  <section class="products-section">
    <input type="text" id="searchInput" placeholder="ค้นหาสินค้า...">
    <div id="productList" class="product-grid"></div>
  </section>

  <!-- ตะกร้าสินค้า -->
  <section class="cart-section">
    <h2>ตะกร้าสินค้า</h2>
    <div id="cartItems"></div>
    <div class="cart-summary">
      <p>รวม: <span id="cartTotal">0</span> บาท</p>
      <button onclick="checkout()">ชำระเงิน</button>
    </div>
  </section>
</main>
{% endblock %}

{% block script %}
<script>
  const token = localStorage.getItem("access_token");

  // โหลดสินค้า
  fetch('/api/products', {
    headers: { 'Authorization': 'Bearer ' + token }
  })
  .then(res => res.json())
  .then(data => {
    const list = document.getElementById('productList');
    data.products.forEach(p => {
      const div = document.createElement('div');
      div.className = 'product-item';
      div.innerHTML = `<h3>${p.name}</h3><p>${p.price} บาท</p><button onclick='addToCart(${JSON.stringify(p)})'>เพิ่ม</button>`;
      list.appendChild(div);
    });
  });

  let cart = [];
  function addToCart(product) {
    const found = cart.find(p => p.id === product.id);
    if (found) found.qty++;
    else cart.push({ ...product, qty: 1 });
    renderCart();
  }

  function renderCart() {
    const cartList = document.getElementById("cartItems");
    const total = document.getElementById("cartTotal");
    cartList.innerHTML = "";
    let sum = 0;
    cart.forEach(item => {
      const div = document.createElement("div");
      div.innerText = `${item.name} x ${item.qty} = ${item.price * item.qty} บาท`;
      cartList.appendChild(div);
      sum += item.price * item.qty;
    });
    total.innerText = sum;
  }

  function checkout() {
    alert("ระบบชำระเงินยังไม่พร้อม");
  }
</script>
{% endblock %}
