<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="{{ url_for('static', filename='js/user.js') }}"></script>
</head>
<body class="dashboard">
  <nav class="navbar">
    <div class="navbar-content">
      <a class="navbar-brand" href="#">üè™ POS Admin</a>
      <ul class="navbar-nav">
        <li><a href="/dashboard" class="active">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</a></li>
        <li><a href="/pos">‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (POS)</a></li>
        <li><a href="/products">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a></li>
        <li><a href="/sales-history">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</a></li>
        <li id="reportsMenu"><a href="/reports">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</a></li>
        <li id="usersMenu"><a href="/users">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</a></li>
        <li id="settingsMenu"><a href="/settings">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</a></li>
        <li><a href="/" target="_blank">üõçÔ∏è ‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</a></li>
      </ul>
      <div class="user-info">
        <span id="userRole" class="user-role"></span>
        <span id="userName">...</span>
        <button class="logout-btn" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>
  </nav>

  <!-- Access Denied Message -->
  <div id="accessDenied" class="access-denied" style="display: none;">
    <div class="access-denied-content">
      <h2>üö´ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</h2>
      <p>‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</p>
      <p>‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin, Manager ‡πÅ‡∏•‡∏∞ Staff ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
      <div class="access-denied-actions">
        <button onclick="goToStore()" class="btn btn-primary">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</button>
        <button onclick="logout()" class="btn btn-outline">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>
  </div>

  <main class="main-content" id="mainContent">
    <div class="page-header">
      <h1>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h1>
      <p>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
    </div>

    <div class="cards-grid">
      <div class="card">
        <div class="card-header">
          <div class="card-title">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          <div class="card-icon">üí∞</div>
        </div>
        <div class="card-value" id="totalSales">0</div>
        <div class="card-subtitle">‡∏ö‡∏≤‡∏ó</div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
          <div class="card-icon">üì¶</div>
        </div>
        <div class="card-value" id="totalProducts">0</div>
        <div class="card-subtitle">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>
          <div class="card-icon">üë•</div>
        </div>
        <div class="card-value" id="totalUsers">0</div>
        <div class="card-subtitle">‡∏Ñ‡∏ô</div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
          <div class="card-icon">üìà</div>
        </div>
        <div class="card-value" id="todaySales">0</div>
        <div class="card-subtitle">‡∏ö‡∏≤‡∏ó</div>
      </div>
    </div>

    <!-- Role-based Content -->
    <div class="dashboard-sections">
      <!-- Quick Actions Section -->
      <section class="dashboard-section">
        <h2>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡πà‡∏ß‡∏ô</h2>
        <div class="quick-actions">
          <button class="quick-action-btn" onclick="window.location.href='/pos'">
            <div class="quick-action-icon">üõí</div>
            <div class="quick-action-text">‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
          </button>
          <button class="quick-action-btn" onclick="window.location.href='/products'" id="manageProductsBtn">
            <div class="quick-action-icon">üì¶</div>
            <div class="quick-action-text">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
          </button>
          <button class="quick-action-btn" onclick="window.location.href='/sales-history'">
            <div class="quick-action-icon">üìã</div>
            <div class="quick-action-text">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</div>
          </button>
          <button class="quick-action-btn" onclick="window.open('/', '_blank')">
            <div class="quick-action-icon">üõçÔ∏è</div>
            <div class="quick-action-text">‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</div>
          </button>
        </div>
      </section>

      <!-- Recent Activities (for all roles) -->
      <section class="dashboard-section">
        <h2>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
        <div id="recentActivities" class="recent-activities">
          <div class="activity-loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        </div>
      </section>
    </div>
  </main>

  <script>
    let currentUser = null;
    let userPermissions = null;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    document.addEventListener('DOMContentLoaded', function() {
      const token = localStorage.getItem('access_token');
      if (!token) {
        window.location.href = "/login";
        return;
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö profile ‡πÅ‡∏•‡∏∞ role
      Promise.all([
        fetch('/api/auth/profile', {
          headers: { 'Authorization': 'Bearer ' + token }
        }),
        fetch('/api/auth/check-role', {
          headers: { 'Authorization': 'Bearer ' + token }
        })
      ])
      .then(responses => Promise.all(responses.map(r => r.json())))
      .then(([profileData, roleData]) => {
        currentUser = profileData.user;
        userPermissions = roleData.permissions;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
        if (!userPermissions.can_access_dashboard) {
          showAccessDenied();
          return;
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        showUserInterface();
        
        // ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏≤‡∏° role
        adjustMenuByRole();
        
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• dashboard
        loadDashboardData();
        loadRecentActivities();
      })
      .catch(error => {
        console.error('Error:', error);
        localStorage.removeItem('access_token');
        window.location.href = "/login";
      });
    });

    function showAccessDenied() {
      document.getElementById('accessDenied').style.display = 'flex';
      document.getElementById('mainContent').style.display = 'none';
      document.querySelector('.navbar').style.display = 'none';
    }

    function showUserInterface() {
      document.getElementById("userName").textContent = currentUser.username;
      document.getElementById("userRole").textContent = getRoleDisplayName(currentUser.role);
    }

    function getRoleDisplayName(role) {
      const roleNames = {
        'admin': 'üëë Admin',
        'manager': 'üëî Manager',
        'staff': 'üë®‚Äçüíº Staff',
        'user': 'üë§ User'
      };
      return roleNames[role] || role;
    }

    function adjustMenuByRole() {
      // ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
      if (!userPermissions.can_manage_users) {
        document.getElementById('usersMenu').style.display = 'none';
      }
      
      if (!userPermissions.can_view_reports) {
        document.getElementById('reportsMenu').style.display = 'none';
      }
      
      if (currentUser.role === 'staff') {
        document.getElementById('settingsMenu').style.display = 'none';
      }

      // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° quick actions
      if (!userPermissions.can_manage_products) {
        document.getElementById('manageProductsBtn').style.display = 'none';
      }
    }

    function loadDashboardData() {
      fetch('/api/reports/dashboard-stats', {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('access_token') }
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById("totalSales").textContent = Number(data.total_sales || 0).toLocaleString();
        document.getElementById("totalProducts").textContent = data.total_products || 0;
        document.getElementById("totalUsers").textContent = data.total_users || 0;
        document.getElementById("todaySales").textContent = Number(data.today_sales || 0).toLocaleString();
      })
      .catch(error => {
        console.error('Error loading dashboard stats:', error);
      });
    }

    function loadRecentActivities() {
      // Simulate recent activities - ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å API
      const activities = [
        { time: '10:30', action: '‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', detail: '‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ 3 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ 450 ‡∏ö‡∏≤‡∏ó' },
        { time: '10:15', action: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà', detail: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "‡∏Å‡∏≤‡πÅ‡∏ü‡πÄ‡∏¢‡πá‡∏ô" ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö' },
        { time: '09:45', action: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥⁄©', detail: '‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà 1 ‡∏Ñ‡∏ô' },
        { time: '09:30', action: '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', detail: '‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' }
      ];

      const container = document.getElementById('recentActivities');
      container.innerHTML = '';

      activities.forEach(activity => {
        const activityElement = document.createElement('div');
        activityElement.className = 'activity-item';
        activityElement.innerHTML = `
          <div class="activity-time">${activity.time}</div>
          <div class="activity-content">
            <div class="activity-action">${activity.action}</div>
            <div class="activity-detail">${activity.detail}</div>
          </div>
        `;
        container.appendChild(activityElement);
      });
    }

    function goToStore() {
      window.location.href = '/';
    }

    function logout() {
      localStorage.removeItem("access_token");
      localStorage.removeItem("user_data");
      window.location.href = "/login";
    }
  </script>

  <style>
    /* Dashboard Styles */
    .dashboard {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f5f7fa;
    }

    .navbar {
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .navbar-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
    }

    .navbar-brand {
      font-size: 1.5rem;
      font-weight: bold;
      color: #333;
      text-decoration: none;
    }

    .navbar-nav {
      display: flex;
      list-style: none;
      gap: 2rem;
      margin: 0;
      padding: 0;
    }

    .navbar-nav a {
      text-decoration: none;
      color: #666;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      transition: all 0.3s;
    }

    .navbar-nav a:hover,
    .navbar-nav a.active {
      background: #667eea;
      color: white;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-role {
      font-size: 0.9rem;
      padding: 0.25rem 0.75rem;
      background: #e3f2fd;
      color: #1976d2;
      border-radius: 15px;
      font-weight: 500;
    }

    .logout-btn {
      padding: 0.5rem 1rem;
      background: #ff4757;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.3s;
    }

    .logout-btn:hover {
      background: #ff3742;
    }

    .main-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .page-header {
      text-align: center;
      margin-bottom: 3rem;
    }

    .page-header h1 {
      color: #333;
      margin-bottom: 0.5rem;
    }

    .page-header p {
      color: #666;
      font-size: 1.1rem;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2rem;
      margin-bottom: 3rem;
    }

    .card {
      background: white;
      border-radius: 15px;
      padding: 2rem;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      transition: transform 0.3s;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .card-title {
      font-weight: 600;
      color: #333;
    }

    .card-icon {
      font-size: 2rem;
    }

    .card-value {
      font-size: 2.5rem;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 0.5rem;
    }

    .card-subtitle {
      color: #666;
      font-size: 0.9rem;
    }

    .dashboard-sections {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
    }

    .dashboard-section {
      background: white;
      border-radius: 15px;
      padding: 2rem;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }

    .dashboard-section h2 {
      color: #333;
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
    }

    .quick-action-btn {
      background: #f8f9ff;
      border: 2px solid #e3f2fd;
      border-radius: 10px;
      padding: 1.5rem;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
    }

    .quick-action-btn:hover {
      background: #667eea;
      color: white;
      transform: translateY(-3px);
    }

    .quick-action-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .quick-action-text {
      font-weight: 500;
      font-size: 0.9rem;
    }

    .recent-activities {
      max-height: 400px;
      overflow-y: auto;
    }

    .activity-item {
      display: flex;
      gap: 1rem;
      padding: 1rem 0;
      border-bottom: 1px solid #eee;
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-time {
      font-weight: 500;
      color: #667eea;
      min-width: 60px;
    }

    .activity-content {
      flex: 1;
    }

    .activity-action {
      font-weight: 500;
      color: #333;
      margin-bottom: 0.25rem;
    }

    .activity-detail {
      color: #666;
      font-size: 0.9rem;
    }

    .activity-loading {
      text-align: center;
      color: #666;
      padding: 2rem;
    }

    /* Access Denied Styles */
    .access-denied {
      position: fixed;
      top: 0;
      left: 0;
      width: 100